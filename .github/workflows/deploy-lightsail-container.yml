name: Deploy to Lightsail Container

on:
  push:
    branches:
      - develop

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Verify Lightsail service and region
        env:
          LIGHTSAIL_SERVICE: ${{ secrets.LIGHTSAIL_SERVICE_NAME }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          echo "ðŸ”Ž Checking Lightsail service '$LIGHTSAIL_SERVICE' in region '$AWS_REGION'..."
          aws lightsail get-container-services \
            --service-name "$LIGHTSAIL_SERVICE" \
            --region "$AWS_REGION"

      - name: Build Docker image
        run: |
          IMAGE=service-m2:${{ github.sha }}
          docker build -t $IMAGE .

      - name: Install lightsailctl plugin
        run: |
          curl https://s3.us-west-2.amazonaws.com/lightsailctl/latest/linux-amd64/lightsailctl \
            -o lightsailctl
          chmod +x lightsailctl
          sudo mv lightsailctl /usr/local/bin/

      - name: Push image to Lightsail
        id: push
        env:
          LIGHTSAIL_SERVICE: ${{ secrets.LIGHTSAIL_SERVICE_NAME }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          IMAGE=service-m2:${{ github.sha }}
          OUTPUT=$(aws lightsail push-container-image \
            --service-name "$LIGHTSAIL_SERVICE" \
            --label service-m2 \
            --image "$IMAGE" \
            --region "$AWS_REGION")

          echo "Lightsail push output: $OUTPUT"

          IMAGE_URI=$(echo $OUTPUT | jq -r '.containerImage.image // empty')
          if [ -z "$IMAGE_URI" ]; then
            echo "âŒ ERROR: No se pudo obtener la URI de la imagen de Lightsail"
            exit 1
          fi

          echo "âœ… Imagen subida: $IMAGE_URI"
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

      - name: Create deployment
        env:
          LIGHTSAIL_SERVICE: ${{ secrets.LIGHTSAIL_SERVICE_NAME }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          IMAGE=${{ env.IMAGE_URI }}

          echo '{
            "service": {
              "image": "'"$IMAGE"'",
              "ports": { "3000": "HTTP" },
              "environment": {
                "NODE_ENV": "production"
              }
            }
          }' > containers.json

          echo '{
            "containerName": "service",
            "containerPort": 3000,
            "healthCheck": {
              "path": "/api",
              "successCodes": "200",
              "healthyThreshold": 2,
              "unhealthyThreshold": 2,
              "timeoutSeconds": 5,
              "intervalSeconds": 10
            }
          }' > public.json

          aws lightsail create-container-service-deployment \
            --service-name "$LIGHTSAIL_SERVICE" \
            --containers file://containers.json \
            --public-endpoint file://public.json \
            --region "$AWS_REGION"