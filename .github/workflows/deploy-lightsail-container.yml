name: Deploy to Lightsail Container

on:
  push:
    branches:
      - develop

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Verify Lightsail service and region
        env:
          LIGHTSAIL_SERVICE: ${{ secrets.LIGHTSAIL_SERVICE_NAME }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          echo "🔎 Checking Lightsail service '$LIGHTSAIL_SERVICE' in region '$AWS_REGION'..."
          aws lightsail get-container-services \
            --service-name "$LIGHTSAIL_SERVICE" \
            --region "$AWS_REGION"

      - name: Build Docker image
        run: |
          IMAGE=service-m2:${{ github.sha }}
          docker build -t $IMAGE .

      - name: Install lightsailctl plugin
        run: |
          curl https://s3.us-west-2.amazonaws.com/lightsailctl/latest/linux-amd64/lightsailctl \
            -o lightsailctl
          chmod +x lightsailctl
          sudo mv lightsailctl /usr/local/bin/

      - name: Push image to Lightsail
        id: push
        env:
          LIGHTSAIL_SERVICE: ${{ secrets.LIGHTSAIL_SERVICE_NAME }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          IMAGE=service-m2:${{ github.sha }}
          OUTPUT=$(aws lightsail push-container-image \
            --service-name "$LIGHTSAIL_SERVICE" \
            --label service-m2 \
            --image "$IMAGE" \
            --region "$AWS_REGION")

          echo "Lightsail push output:"
          echo "$OUTPUT"

          # Extraer la referencia de imagen correcta (ej: :service-m2.3)
          IMAGE_URI=$(echo "$OUTPUT" | grep -oP 'Refer to this image as "\K[^"]+')
          if [ -z "$IMAGE_URI" ]; then
            echo "❌ ERROR: No se pudo extraer IMAGE_URI"
            exit 1
          fi

          echo "✅ Imagen registrada como: $IMAGE_URI"
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

      - name: Create deployment
        env:
          LIGHTSAIL_SERVICE: ${{ secrets.LIGHTSAIL_SERVICE_NAME }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          IMAGE=${{ env.IMAGE_URI }}

          echo '{
            "service": {
              "image": "'"$IMAGE"'",
              "ports": { "3000": "HTTP" },
              "environment": {
                "APP_ENV": "'"${{ secrets.APP_ENV }}"'",
                "DB_USERNAME": "'"${{ secrets.DB_USERNAME }}"'",
                "DB_PASSWORD": "'"${{ secrets.DB_PASSWORD }}"'",
                "DB_PORT": "'"${{ secrets.DB_PORT }}"'",
                "DB_NAME": "'"${{ secrets.DB_NAME }}"'",
                "DB_HOST": "'"${{ secrets.DB_HOST }}"'",
                "FIREBASE_PROJECT_ID": "'"${{ secrets.FIREBASE_PROJECT_ID }}"'",
                "FIREBASE_PRIVATE_KEY_ID": "'"${{ secrets.FIREBASE_PRIVATE_KEY_ID }}"'",
                "FIREBASE_PRIVATE_KEY": "'"${{ secrets.FIREBASE_PRIVATE_KEY }}"'",
                "FIREBASE_EMAIL": "'"${{ secrets.FIREBASE_EMAIL }}"'",
                "FIREBASE_CLIENT_ID": "'"${{ secrets.FIREBASE_CLIENT_ID }}"'",
                "FIREBASE_AUTH_URI": "'"${{ secrets.FIREBASE_AUTH_URI }}"'",
                "FIREBASE_TOKEN_URI": "'"${{ secrets.FIREBASE_TOKEN_URI }}"'",
                "FIREBASE_AUTH_PROVIDER": "'"${{ secrets.FIREBASE_AUTH_PROVIDER }}"'",
                "FIREBASE_CLIENT": "'"${{ secrets.FIREBASE_CLIENT }}"'",
                "FIREBASE_UNIVERSE_DOMAIN": "'"${{ secrets.FIREBASE_UNIVERSE_DOMAIN }}"'"
              }
            }
          }' > containers.json

          echo '{
            "containerName": "service",
            "containerPort": 3000,
            "healthCheck": {
              "path": "/api",
              "successCodes": "200",
              "healthyThreshold": 2,
              "unhealthyThreshold": 2,
              "timeoutSeconds": 5,
              "intervalSeconds": 10
            }
          }' > public.json

          aws lightsail create-container-service-deployment \
            --service-name "$LIGHTSAIL_SERVICE" \
            --containers file://containers.json \
            --public-endpoint file://public.json \
            --region "$AWS_REGION"
